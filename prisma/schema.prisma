// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  // output = "../src/generated/client"
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  HOLIDAY
}

enum SalaryMonthStatus {
  PENDING // not processed yet
  GENERATED // calculated
  CREDITED // salary credited
  HOLD // on hold
}

enum SalaryNoticeStatus {
  SENT
  VIEWED
  ACKNOWLEDGED
}

enum JDVisibility {
  ACTIVE
  INACTIVE
}

enum JobType {
  FULL_TIME
  REMOTE
  CONTRACT
  FREELANCE
  PART_TIME
  INTERNSHIP
  TEMPORARY
}

// ------------------------------------------------------------------
// Account Profile (Personal + Contact + Admin Approval Metadata)
// ------------------------------------------------------------------

model Account {
  id             String    @id @default(uuid())
  registerNumber String    @unique
  firstName      String
  lastName       String
  contactEmail   String    @unique
  contactPhone   String    @unique
  address        Json?
  avatar         String?
  documents      Json? // optional file metadata (Aadhar, etc.)
  bio            Json?
  isActive       Boolean   @default(false) // only true after admin approval
  jobType        JobType?
  isJdAccept     Boolean   @default(false)
  designation    String?
  joinedAt       DateTime? // set when approved
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isBusy         Boolean   @default(false)
  isAvailable    Boolean   @default(false)

  activeLeadId String?
  activeLead   Lead?   @relation(fields: [activeLeadId], references: [id])

  // Relation to
  user            User?
  registration    RegistrationRequest?
  jobDescriptions JobDescription?
  teams           TeamMember[]
  taskAssignments TaskAssignment[]

  salaryStructure SalaryStructure?
  monthlySalaries MonthlySalary[]
  salaryNotices   SalaryNotice[]

  bankDetails    BankDetail?
  attendanceLogs AttendanceLog[]
  leaveRequests  LeaveRequest[]
  busyLogs       BusyActivityLog[]

  leadActivityLogs          LeadActivityLog[]
  leads                     Lead[]                     @relation("LeadCreatedBy")
  leadAssignments           LeadAssignment[]           @relation("LeadAssignedBy")
  assignedLeadAssignments   LeadAssignment[]           @relation("LeadAssignedTo")
  // linkedLeads      Lead[]            @relation("LeadAccount")
  customers                 Customer[]
  notifications             Notification[]
  notificationSubscriptions NotificationSubscription[]
  messageTemplates          MessageTemplate[]
  templatePreferences       TemplatePreference[]
  // dailyStatusReports        DailyStatusReport[]
  dsuEntries                DsuEntry[]
  leadHelpers               LeadHelper[]               @relation("HelperAccount")
  addedHelpers              LeadHelper[]               @relation("HelperAddedBy")
  // employeeLeadWorks         EmployeeLeadWork[]
  checkLogs                 CheckLog[]
  projectMembers            ProjectMember[]
  taskComments              TaskComment[]
  commentMentions           CommentMention[]
  taskWatchers              TaskWatcher[]
  taskTimeEntries           TaskTimeEntry[]

  @@index([isActive])
  @@index([jobType])
  @@index([contactEmail])
}

// ------------------------------------------------------------------
// Authentication User (Login Credentials + JWT Support)
// ------------------------------------------------------------------

model User {
  id        String  @id @default(uuid())
  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique

  username           String? @unique
  passwordHash       String?
  mustChangePassword Boolean @default(true) // on first login after creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RBAC
  roles UserRole[]

  // OTP for forgot password
  otps PasswordOTP[]

  @@index([username])
}

// ------------------------------------------------------------------
// Registration Approval Workflow
// ------------------------------------------------------------------

model RegistrationRequest {
  id           String   @id @default(uuid())
  firstName    String?
  lastName     String?
  contactEmail String?  @unique
  contactPhone String?  @unique
  account      Account? @relation(fields: [accountId], references: [id])
  accountId    String?  @unique

  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedAt DateTime  @default(now())
  decidedAt   DateTime?
  decidedBy   String? // admin user id if approved/rejected
  // @@index([accountId])

  @@index([status])
  @@index([requestedAt])
}

// ------------------------------------------------------------------
// Salary & Bank
// ------------------------------------------------------------------

model SalaryStructure {
  id String @id @default(uuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  baseSalary Decimal  @db.Decimal(12, 2)
  hraPercent Decimal? @db.Decimal(5, 2) // Changed precision for percentage
  allowance  Decimal? @db.Decimal(12, 2)

  effectiveFrom DateTime

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  revisions SalaryRevision[]
  monthly   MonthlySalary[]

  @@index([effectiveFrom])
}

model SalaryRevision {
  id String @id @default(uuid())

  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  previousSalary Decimal @db.Decimal(12, 2)
  revisedSalary  Decimal @db.Decimal(12, 2)

  applicableFrom DateTime
  reason         String?

  revisedBy String
  revisedAt DateTime @default(now())

  notices SalaryNotice[]

  @@index([salaryStructureId])
  @@index([applicableFrom])
}

model MonthlySalary {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id])

  month Int
  year  Int

  basic      Decimal @db.Decimal(12, 2)
  hra        Decimal @db.Decimal(12, 2)
  allowances Decimal @db.Decimal(12, 2)
  deductions Decimal @db.Decimal(12, 2)
  netPay     Decimal @db.Decimal(12, 2)

  status SalaryMonthStatus @default(PENDING)

  note String?

  generatedAt DateTime?
  creditedAt  DateTime?

  statement SalaryStatement?
  notices   SalaryNotice[]

  @@unique([accountId, month, year])
  @@index([status])
  @@index([year, month])
}

model SalaryStatement {
  id String @id @default(uuid())

  monthlySalaryId String        @unique
  monthlySalary   MonthlySalary @relation(fields: [monthlySalaryId], references: [id], onDelete: Cascade)

  generatedAt DateTime @default(now())
  pdfUrl      String?
}

model SalaryNotice {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  revisionId String?
  revision   SalaryRevision? @relation(fields: [revisionId], references: [id], onDelete: SetNull)

  monthlySalaryId String?
  monthlySalary   MonthlySalary? @relation(fields: [monthlySalaryId], references: [id], onDelete: SetNull)

  message String?
  status  SalaryNoticeStatus @default(SENT)

  sentBy         String
  sentAt         DateTime  @default(now())
  viewedAt       DateTime?
  acknowledgedAt DateTime?

  @@index([accountId])
  @@index([sentAt])
}

model BankDetail {
  id String @id @default(uuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  bankName      String
  accountHolder String
  accountNumber String // üîê encrypt at application level
  ifscCode      String
  branch        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------------------------------------------
// Busy Activity Log
// ------------------------------------------------------------------

model BusyActivityLog {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  fromBusy Boolean
  toBusy   Boolean

  reason String? // Meeting, Task, Manual, Auto

  createdAt DateTime @default(now())

  @@index([accountId])
}

// ------------------------------------------------------------------
// RBAC: Roles & Permissions
// ------------------------------------------------------------------

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  userRoles   UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String  @id @default(uuid())
  key         String  @unique // e.g. "USER_CREATE"
  description String?

  rolePermissions RolePermission[]
}

model UserRole {
  user   User   @relation(fields: [userId], references: [id])
  userId String
  role   Role   @relation(fields: [roleId], references: [id])
  roleId String

  @@id([userId, roleId])
}

model RolePermission {
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@id([roleId, permissionId])
}

// ------------------------------------------------------------------
// Forgot Password OTP Store
// ------------------------------------------------------------------

model PasswordOTP {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  otpCode   String // hashed or plain if ephemeral
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, used])
}

// ------------------------------------------------------------------
// Job Description Store
// ------------------------------------------------------------------

model JobDescription {
  id String @id @default(uuid())

  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique

  title       String // e.g. "Backend Developer"
  designation String? // optional mapping to Account.designation
  summary     String? // short JD intro

  responsibilitiesMust    Json // must do
  responsibilitiesMay     Json // may do
  responsibilitiesMustNot Json // not allowed / must not do

  companyRules Json // HR / company rules
  expectations Json? // KPIs / expectations
  notes        Json?

  visibility JDVisibility @default(ACTIVE)

  createdBy String? // admin user id
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([designation])
  @@index([visibility])
}

// ------------------------------------------------------------------
// Team Store
// ------------------------------------------------------------------

model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Ownership / audit
  createdBy String? // admin/user id
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members         TeamMember[]
  taskAssignments TaskAssignment[]
  leadAssignments LeadAssignment[]
  dsuTemplates    DsuTemplate[]

  @@unique([name])
  @@index([isActive])
}

model TeamMember {
  id String @id @default(uuid())

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId String

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String

  isActive Boolean @default(true)

  // Optional team-level role (future-ready)
  role     String? // e.g. LEAD, MEMBER
  joinedAt DateTime @default(now())

  @@unique([teamId, accountId]) // prevents duplicate membership
  @@index([accountId])
  @@index([teamId])
}

// ------------------------------------------------------------------
// Project Store
// ------------------------------------------------------------------

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  CANCELLED
  ARCHIVED
}

enum ProjectVisibility {
  PRIVATE // Only assigned members
  TEAM // All members of the linked team(s)
  PUBLIC // All workspace users
}

enum PipelineSource {
  BLANK // Built from scratch
  TEMPLATE // Cloned from a PipelineTemplate
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  IN_REVIEW
  BLOCKED
  COMPLETED
  CANCELLED
}

enum AssignmentType {
  ACCOUNT
  TEAM
}

enum ActivityEntity {
  PROJECT
  PIPELINE
  PIPELINE_STEP
  TASK
  COMMENT
  ATTACHMENT
  LABEL
}

enum TaskRecurrenceType {
  ONE_TIME
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
  QUARTERLY
  CUSTOM
}

enum TemplateAssignmentStrategy {
  PROJECT_ROLE // Assign to whoever holds a project role
  CREATOR // Auto-assign to the project creator
  UNASSIGNED // Leave unassigned until manually set
}

enum TaskPriority {
  NONE // No priority set
  LOW
  MEDIUM
  HIGH
  URGENT // Requires immediate attention
}

enum ProjectRoleType {
  OWNER // Full control ‚Äî usually the creator
  MANAGER // Can edit project, assign tasks, manage pipeline
  MEMBER // Can update their assigned tasks
  VIEWER // Read-only
  REVIEWER // Can approve/review tasks and leave comments
}

enum ActivityAction {
  CREATED
  UPDATED
  DELETED
  ASSIGNED
  UNASSIGNED
  STATUS_CHANGED
  PRIORITY_CHANGED
  DUE_DATE_CHANGED
  MOVED // Task moved between steps/columns
  COMMENTED
  ATTACHMENT_ADDED
  ATTACHMENT_REMOVED
  COMPLETED
  REOPENED
  BLOCKED
  UNBLOCKED
  ARCHIVED
  RESTORED
}

enum ChecklistItemStatus {
  PENDING
  COMPLETED
}

enum CommentVisibility {
  ALL // Everyone with project access
  MANAGERS // Only project managers + owner
}

enum AttachmentSource {
  UPLOAD // Direct file upload
  URL // External link
  GDRIVE // Google Drive
  NOTION
  FIGMA
  GITHUB_PR
}

// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//  LABELS  (workspace-level, reusable across projects)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

model Label {
  id       String  @id @default(uuid())
  name     String
  color    String // hex e.g. "#F59E0B"
  isActive Boolean @default(true)

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  taskLabels TaskLabel[]

  @@unique([name])
  @@index([isActive])
}

model TaskLabel {
  id      String @id @default(uuid())
  taskId  String
  task    Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  labelId String
  label   Label  @relation(fields: [labelId], references: [id], onDelete: Cascade)

  addedBy String?
  addedAt DateTime @default(now())

  @@unique([taskId, labelId])
  @@index([taskId])
  @@index([labelId])
}

model Project {
  id          String            @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus     @default(DRAFT)
  visibility  ProjectVisibility @default(TEAM)

  // Dates
  startDate   DateTime?
  endDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  // Cover / branding
  color    String? // hex colour for the project card
  icon     String? // emoji or icon identifier
  coverUrl String? // banner image

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pipeline     ProjectPipeline?
  tasks        Task[]
  members      ProjectMember[]
  activity     ActivityLog[]
  attachments  ProjectAttachment[]
  customFields ProjectCustomField[]

  @@index([status])
  @@index([deletedAt])
  @@index([createdBy])
  @@index([visibility])
}

model ProjectMember {
  id String @id @default(uuid())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  role ProjectRoleType @default(MEMBER)

  joinedAt DateTime @default(now())
  addedBy  String? // accountId of whoever added them

  @@unique([projectId, accountId])
  @@index([projectId])
  @@index([accountId])
  @@index([role])
}

model ProjectAttachment {
  id String @id @default(uuid())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  name      String
  source    AttachmentSource @default(UPLOAD)
  url       String
  mimeType  String?
  sizeBytes Int?
  meta      Json? // thumbnail, previewUrl, etc.

  uploadedBy String?
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?

  @@index([projectId])
  @@index([deletedAt])
}

model ProjectCustomField {
  id String @id @default(uuid())

  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String

  name      String
  fieldType String // "TEXT" | "NUMBER" | "DATE" | "SELECT" | "MULTI_SELECT" | "BOOLEAN" | "URL"
  options   Json? // Array of options for SELECT / MULTI_SELECT
  order     Int     @default(0)
  required  Boolean @default(false)
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())

  values TaskCustomFieldValue[]

  @@unique([projectId, name])
  @@index([projectId])
}

model TaskCustomFieldValue {
  id String @id @default(uuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  field   ProjectCustomField @relation(fields: [fieldId], references: [id], onDelete: Cascade)
  fieldId String

  value     String? // JSON-serialised for complex types
  updatedAt DateTime @updatedAt

  @@unique([taskId, fieldId])
  @@index([taskId])
  @@index([fieldId])
}

model PipelineTemplate {
  id          String  @id @default(uuid())
  name        String
  description String?
  isActive    Boolean @default(true)

  createdBy String? // accountId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps PipelineTemplateStep[]

  @@unique([name])
  @@index([isActive])
}

model PipelineTemplateStep {
  id String @id @default(uuid())

  templateId String
  template   PipelineTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name        String
  order       Int
  description String?
  color       String?

  defaultTasks PipelineTemplateTask[] // [{ title, description, role, assignees }]

  @@index([templateId])
  @@index([order])
}

model PipelineTemplateTask {
  id     String               @id @default(uuid())
  stepId String
  step   PipelineTemplateStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  title       String
  description String?
  priority    TaskPriority @default(NONE)

  // Logic for due dates relative to project start
  offsetDays Int? @default(0) // e.g. Due 2 days after step starts

  // Who should this be assigned to by default?
  defaultAssignmentStrategy TemplateAssignmentStrategy?
  defaultRoleId             String? // If strategy is PROJECT_ROLE

  @@index([stepId])
}

// ------------------------------------------------------------------
// Live Project Pipeline
// ------------------------------------------------------------------

model ProjectPipeline {
  id String @id @default(uuid())

  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  source           PipelineSource @default(BLANK)
  sourceTemplateId String?

  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps PipelineStep[]
}

model PipelineStep {
  id String @id @default(uuid())

  pipeline   ProjectPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  pipelineId String

  name        String
  description String?
  color       String?
  order       Int
  isTerminal  Boolean @default(false)

  wipLimit Int @default(0)

  templateStepId String?

  tasks Task[]

  @@index([pipelineId])
  @@index([order])
}

model Task {
  id String @id @default(uuid())

  // Project / pipeline placement
  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String?

  step   PipelineStep? @relation(fields: [stepId], references: [id], onDelete: SetNull)
  stepId String?

  // Core fields
  title       String
  description String? // Rich text / markdown
  status      TaskStatus   @default(PENDING)
  priority    TaskPriority @default(NONE)

  // Date tracking
  startDate   DateTime?
  dueDate     DateTime?
  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  // Time tracking (in minutes)
  estimatedMinutes Int?
  loggedMinutes    Int  @default(0)

  // Personal / standalone task (no project)
  isSelfTask Boolean @default(false)

  // Sort order within its column (fractional indexing friendly)
  sortOrder Float @default(0)

  // Recurrence
  isRecurring    Boolean            @default(false)
  recurrenceType TaskRecurrenceType @default(ONE_TIME)
  recurrenceRule Json?

  // Recurrence chain: links recurring instances to their parent definition
  recurrenceParentId String?
  recurrenceParent   Task?   @relation("RecurringInstances", fields: [recurrenceParentId], references: [id], onDelete: SetNull)
  recurrenceChildren Task[]  @relation("RecurringInstances")

  // Subtask hierarchy
  parentTaskId String?
  parentTask   Task?   @relation("SubTasks", fields: [parentTaskId], references: [id], onDelete: SetNull)
  subTasks     Task[]  @relation("SubTasks")

  templateTaskId String?

  // Soft delete
  deletedAt DateTime?
  deletedBy String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  assignments  TaskAssignment[]
  activity     ActivityLog[]
  comments     TaskComment[]
  attachments  TaskAttachment[]
  labels       TaskLabel[]
  checklist    ChecklistItem[]
  dependencies TaskDependency[]       @relation("DependentTask")
  dependents   TaskDependency[]       @relation("BlockingTask")
  watchers     TaskWatcher[]
  timeEntries  TaskTimeEntry[]
  customValues TaskCustomFieldValue[]

  @@index([projectId])
  @@index([stepId])
  @@index([status])
  @@index([priority])
  @@index([dueDate])
  @@index([deletedAt])
  @@index([parentTaskId])
  @@index([recurrenceParentId])
  @@index([isSelfTask])
  @@index([sortOrder])
  @@index([createdBy])
  @@index([projectId, status]) // filter tasks by project + status (kanban column query)
  @@index([projectId, dueDate]) // filter by project + due date (calendar view)
  @@index([stepId, sortOrder]) // ordered column fetch
}

model TaskAssignment {
  id String @id @default(uuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  type      AssignmentType
  accountId String?
  account   Account?       @relation(fields: [accountId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  assignedAt DateTime @default(now())
  assignedBy String?

  status    TaskStatus @default(PENDING)
  note      String?
  updatedAt DateTime?

  @@index([taskId])
  @@index([accountId])
  @@index([teamId])
}

model TaskDependency {
  id String @id @default(uuid())

  dependentTaskId String
  dependentTask   Task   @relation("DependentTask", fields: [dependentTaskId], references: [id], onDelete: Cascade)

  blockingTaskId String
  blockingTask   Task   @relation("BlockingTask", fields: [blockingTaskId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  createdBy String?

  @@unique([dependentTaskId, blockingTaskId])
  @@index([dependentTaskId])
  @@index([blockingTaskId])
}

model ChecklistItem {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  title  String
  status ChecklistItemStatus @default(PENDING)
  order  Int                 @default(0)

  assignedTo String? // accountId
  dueDate    DateTime?

  completedAt DateTime?
  completedBy String?

  createdBy String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([order])
}

model TaskComment {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  content    String // Markdown / rich text
  visibility CommentVisibility @default(ALL)

  // Thread support: null = top-level, set = reply
  parentCommentId String?
  parentComment   TaskComment?  @relation("CommentReplies", fields: [parentCommentId], references: [id], onDelete: SetNull)
  replies         TaskComment[] @relation("CommentReplies")

  mentions CommentMention[]

  // Reactions stored as JSON for simplicity: { "üëç": ["accountId1"], "üî•": ["accountId2"] }
  reactions Json?

  editedAt  DateTime?
  deletedAt DateTime?
  deletedBy String?

  authorId  String
  author    Account  @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([authorId])
  @@index([parentCommentId])
  @@index([deletedAt])
}

model CommentMention {
  id        String      @id @default(uuid())
  comment   TaskComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  commentId String

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  notified  Boolean  @default(false)
  createdAt DateTime @default(now())

  @@unique([commentId, accountId])
  @@index([accountId])
}

model TaskAttachment {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  name      String
  source    AttachmentSource @default(UPLOAD)
  url       String
  mimeType  String?
  sizeBytes Int?
  meta      Json? // thumbnailUrl, dimensions, previewUrl, integrationId

  uploadedBy String?
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?

  @@index([taskId])
  @@index([deletedAt])
}

model TaskWatcher {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  watchedAt DateTime @default(now())

  @@unique([taskId, accountId])
  @@index([taskId])
  @@index([accountId])
}

model TaskTimeEntry {
  id     String @id @default(uuid())
  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  startedAt       DateTime
  endedAt         DateTime?
  durationMinutes Int? // Set on stop; null = still running

  description String? // What was worked on
  isBillable  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([taskId])
  @@index([accountId])
  @@index([startedAt])
}

model ActivityLog {
  id String @id @default(uuid())

  entityType ActivityEntity
  entityId   String

  action ActivityAction
  meta   Json? // Context-specific payload (e.g. { "from": "TODO", "to": "IN_PROGRESS" })

  // Snapshot of the entity before/after (for rollback / diffing)
  fromState Json?
  toState   Json?

  performedBy String? // accountId; null = system
  createdAt   DateTime @default(now())

  // Denormalised FKs for fast queries
  project   Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  projectId String?

  task   Task?   @relation(fields: [taskId], references: [id], onDelete: SetNull)
  taskId String?

  @@index([entityType, entityId])
  @@index([projectId])
  @@index([taskId])
  @@index([performedBy])
  @@index([createdAt])
}

// ------------------------------------------------------------------
// Lead & Support Store
// ------------------------------------------------------------------

enum LeadSource {
  MANUAL
  WHATSAPP
  INQUIRY_FORM
  WEBSITE
  YOUTUBE
  ADVERTISEMENT
}

enum LeadType {
  LEAD
  SUPPORT
}

enum LeadStatus {
  PENDING
  IN_PROGRESS
  DEMO_DONE
  INTERESTED
  CONVERTED
  CLOSED
}

enum LeadActivityAction {
  CREATED
  ASSIGNED
  STATUS_CHANGED
  ASSIGN_CHANGED
  UPDATED
  CLOSED
  HELPER_ADDED
  HELPER_REMOVED
  WORK_STARTED
  WORK_ENDED
}

enum LeadHelperRole {
  EXPORT
  SUPPORT
  CONSULT
}

model Lead {
  id String @id @default(uuid())

  source     LeadSource
  type       LeadType
  status     LeadStatus @default(PENDING)
  statusMark Json?

  demoScheduledAt DateTime?
  demoDoneAt      DateTime?
  demoCount       Int       @default(0)
  demoMeta        Json?
  // {
  //   history: [
  //     { type: "SCHEDULED", at: DateTime, by: accountId },
  //     { type: "RESCHEDULED", at: DateTime, by: accountId },
  //     { type: "DONE", at: DateTime, by: accountId }
  //   ]
  // }

  customerName String
  mobileNumber String
  product      Json? // { id, slug, link, title }
  productTitle String? // denormalized for fast search/filter
  cost         Decimal? @db.Decimal(12, 2)
  remark       String?

  isActive  Boolean @default(true)
  isWorking Boolean @default(false)

  createdBy    String? // accountId
  createdByAcc Account?  @relation("LeadCreatedBy", fields: [createdBy], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  closedAt     DateTime?

  totalWorkSeconds Int @default(0)

  // account     Account?          @relation("LeadAccount", fields: [accountId], references: [id])
  // accountId   String?
  assignments LeadAssignment[]
  activity    LeadActivityLog[]
  customer    Customer?         @relation(fields: [customerId], references: [id])
  customerId  String?
  leadHelpers LeadHelper[]
  // employeeLeadWorks EmployeeLeadWork[]
  accounts    Account[]

  @@index([isWorking])
  @@index([createdAt, status])
  @@index([status, demoScheduledAt])
  @@index([status])
  @@index([mobileNumber])
  @@index([demoScheduledAt])
  @@index([demoDoneAt])
}

model LeadAssignment {
  id String @id @default(uuid())

  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId String

  type      AssignmentType
  accountId String?
  account   Account?       @relation("LeadAssignedTo", fields: [accountId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  remark      Json?
  WorkSeconds Int   @default(0)

  isActive Boolean @default(true)

  assignedBy    String? // accountId (who made assignment)
  assignedByAcc Account? @relation("LeadAssignedBy", fields: [assignedBy], references: [id])

  assignedAt   DateTime  @default(now())
  unassignedAt DateTime? // null when active

  @@index([leadId])
  @@index([accountId])
  @@index([teamId])
}

model LeadHelper {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  accountId String
  account   Account @relation("HelperAccount", fields: [accountId], references: [id])

  role LeadHelperRole @default(EXPORT)

  addedBy    String? // accountId
  addedByAcc Account? @relation("HelperAddedBy", fields: [addedBy], references: [id])

  isActive Boolean @default(true)

  addedAt   DateTime  @default(now())
  removedAt DateTime?

  @@unique([leadId, accountId])
  @@index([leadId])
  @@index([accountId])
}

model LeadActivityLog {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  action LeadActivityAction
  meta   Json?

  performedBy        String? // accountId
  performedByAccount Account? @relation(fields: [performedBy], references: [id])
  createdAt          DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
}

// ------------------------------------------------------------------
// Customer Store
// ------------------------------------------------------------------

model Customer {
  id String @id @default(uuid())

  // Basic Info
  name                String
  customerCompanyName String?
  contactPerson       String?

  mobile           String
  normalizedMobile String @unique

  email  String? // primary email
  emails Json? // additional emails
  phones Json? // extra numbers

  city  String?
  state String?

  joiningDate DateTime?

  customerCategory String? // e.g. GOLD / SILVER / REGULAR
  businessCategory String? // e.g. RETAIL / MANUFACTURING / CA / TRADER

  // Tally Info
  tallySerial  String?
  tallyVersion String?

  // Multi Product + History
  products Json?

  notes    String?
  isActive Boolean @default(true)

  createdBy    String?
  createdByAcc Account? @relation(fields: [createdBy], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  leads Lead[]

  @@index([normalizedMobile])
  @@index([customerCompanyName])
  @@index([tallySerial])
  @@index([city])
  @@index([state])
  @@index([customerCategory])
  @@index([businessCategory])
  @@index([createdAt])
  @@index([isActive, createdAt])
}

// ------------------------------------------------------------------
// Notification Store
// ------------------------------------------------------------------

enum NotificationCategory {
  SYSTEM
  REMINDER
  ALERT
  WARNING
  MESSAGE
  TASK
  LEAD
  CUSTOM
}

enum NotificationLevel {
  INFO
  SUCCESS
  WARNING
  ERROR
  CRITICAL
}

model Notification {
  id        String   @id @default(uuid())
  accountId String? // null = broadcast/all
  account   Account? @relation(fields: [accountId], references: [id])

  category NotificationCategory
  level    NotificationLevel    @default(INFO)

  title            String
  body             String // short body
  payload          Json? // full structured payload (for UI / actions)
  actionUrl        String? // browser action target
  dedupeKey        String? // idempotency / merge key e.g. "task:123:reminder"
  deliveryChannels Json? // ["push","socket","email"]

  // client states
  isRead      Boolean   @default(false)
  isHidden    Boolean   @default(false) // user-specific hide
  dismissedAt DateTime?
  remindAt    DateTime? // snooze/reschedule timestamp

  // audit
  createdBy String? // admin/account id who created
  createdAt DateTime  @default(now())
  sentAt    DateTime? // when delivery attempted
  expiresAt DateTime? // optional TTL

  @@index([accountId])
  @@index([category])
  @@index([createdAt])
  @@index([isRead])
  @@index([dedupeKey])
}

model NotificationSubscription {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // WebPush fields
  endpoint String @unique
  p256dh   String
  auth     String

  // meta
  platform  String? // "web", "chrome", "android", "ios"
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
}

// ------------------------------------------------------------------
// Message Template Store (Simple & Dynamic)
// ------------------------------------------------------------------

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
  IN_APP
  PUSH
}

enum TemplateVisibility {
  PRIVATE // account-specific
  PUBLIC // global/shared
}

model MessageTemplate {
  id String @id @default(uuid())

  // Identity
  name        String
  slug        String
  description String?

  // Ownership & visibility
  visibility TemplateVisibility @default(PRIVATE)
  accountId  String?
  account    Account?           @relation(fields: [accountId], references: [id])

  // Channel support
  channels Json
  subject  String?
  body     String

  // Placeholder metadata
  variables Json?
  meta      Json?

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Visibility
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  isDefault  Boolean   @default(false) // ‚≠ê recommended template
  lastUsedAt DateTime? // üß† for smart sorting

  // Behavior
  isActive Boolean @default(true)

  // Audit
  createdBy           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  templatePreferences TemplatePreference[]

  @@unique([accountId, slug])
  @@index([visibility])
  @@index([accountId])
  @@index([isActive])
  @@index([lastUsedAt])
}

model TemplatePreference {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  templateId String
  template   MessageTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // per-account overrides
  isPinned Boolean @default(false)
  priority Int     @default(0)
  isHidden Boolean @default(false) // user chose to hide this template

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, templateId])
  @@index([accountId])
  @@index([templateId])
}

// ------------------------------------------------------------------
// Attendance Check-In / Check-Out Event Log
// ------------------------------------------------------------------

enum CheckType {
  CHECK_IN
  CHECK_OUT
  BREAK_START
  BREAK_END
}

enum BreakType {
  LUNCH
  TEA
  PERSONAL
  OTHER
}

enum CheckSource {
  MANUAL // self-submitted by employee
  AUTO // system auto check-out (e.g. end of day)
  ADMIN // corrected / added by admin
}

enum LeaveType {
  FULL_DAY
  HALF_DAY
  MULTI_DAY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

model CheckLog {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // The attendance day this check belongs to (normalized to 00:00 UTC)
  date DateTime

  // Actual timestamp of the check event
  checkedAt DateTime

  type      CheckType // CHECK_IN or CHECK_OUT
  source    CheckSource @default(MANUAL)
  breakType BreakType?

  // Session pairing ‚Äî each CHECK_IN gets paired with its CHECK_OUT
  // Both the IN and OUT row reference the same sessionId (UUID generated on check-in)
  sessionId String?

  // Location / device metadata (optional)
  ipAddress  String?
  deviceMeta Json? // { userAgent, platform, location: { lat, lng } }

  // Admin override tracking
  note     String? // reason if ADMIN source
  editedBy String? // accountId of admin who added/edited

  createdAt DateTime @default(now())

  // Link back to the summarized attendance log
  attendanceLog   AttendanceLog? @relation(fields: [attendanceLogId], references: [id])
  attendanceLogId String?

  @@index([accountId, date])
  @@index([sessionId])
  @@index([checkedAt])
  @@index([type])
}

// ------------------------------------------------------------------
// Updated AttendanceLog ‚Äî now the daily SUMMARY
// (aggregated from CheckLog, recomputed on each check event)
// ------------------------------------------------------------------

// REPLACE existing AttendanceLog with this:
model AttendanceLog {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // Normalized date (midnight 00:00, server timezone)
  date DateTime
  day  String // "Monday", "Tuesday" ‚Ä¶

  // Convenience: first check-in and last check-out of the day
  firstCheckIn DateTime?
  lastCheckOut DateTime?

  // Total worked minutes derived from all paired sessions
  // App recomputes this after every check event
  totalWorkMinutes Int @default(0)

  // Whether the day has an open/unpaired CHECK_IN (employee forgot to check out)
  hasOpenSession Boolean @default(false)

  status   AttendanceStatus @default(PRESENT)
  isSunday Boolean          @default(false)

  // Admin override note (e.g. "Marked HALF_DAY by HR")
  overrideNote String?
  overrideBy   String? // accountId

  totalBreakMinutes Int     @default(0)
  hasOpenBreak      Boolean @default(false)
  isWFH             Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // All individual check events for this day
  checkLogs CheckLog[]

  @@unique([accountId, date])
  @@index([date])
  @@index([accountId])
  @@index([status])
}

// ------------------------------------------------------------------
// Attendan & Leave
// ------------------------------------------------------------------

model LeaveRequest {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type      LeaveType
  startDate DateTime
  endDate   DateTime?

  reason String

  status LeaveStatus @default(PENDING)

  decidedBy      String? // admin accountId
  decisionReason String?
  decidedAt      DateTime?

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([status])
}

// ------------------------------------------------------------------
// DSU Store (Daily Status Updates)
// ------------------------------------------------------------------

enum DsuFieldType {
  TEXT
  TEXTAREA
  NUMBER
  SELECT
  MULTISELECT
  DATE
  CHECKBOX
  RICH_TEXT
  ATTACHMENT
}

model DsuTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  teamId      String? // optional: template scoped to a team
  createdBy   String? // accountId of creator
  isActive    Boolean  @default(true)
  config      Json // canonical JSON description of sections & fields (also denormalized below)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  team       Team?                @relation(fields: [teamId], references: [id])
  versions   DsuTemplateVersion[]
  dsuEntries DsuEntry[]

  @@index([teamId])
  @@index([isActive])
}

model DsuTemplateVersion {
  id         String      @id @default(uuid())
  templateId String
  template   DsuTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  version    Int
  config     Json // snapshot of config for this version
  createdBy  String?
  createdAt  DateTime    @default(now())

  @@unique([templateId, version])
  @@index([templateId])
}

model DsuEntry {
  id          String    @id @default(uuid())
  templateId  String? // optional ‚Äî if null, free-form
  accountId   String
  teamId      String? // convenience denormalization
  date        DateTime // normalized to midnight (the day this DSU is for)
  content     Json // the actual filled content following template structure
  summary     String? // optional short summary for display / notifications
  attachments Json? // array of { name, url, meta }
  isDraft     Boolean   @default(false)
  submittedAt DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String // accountId who submitted (usually same as accountId)
  meta        Json? // free metadata (ip, device, client-version, etc)
  textSearch  String? // denormalized searchable text (updated by app)

  // relations
  template DsuTemplate? @relation(fields: [templateId], references: [id])
  account  Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, date, templateId])
  @@index([accountId])
  @@index([teamId])
  @@index([date])
  @@index([submittedAt])
}

// enum DailyStatusSection {
//   WORKED_ON // Completed work
//   IN_PROGRESS // Started but not completed
//   QUERY // Blocker / question
//   LEARNING // Today's learning
// }

// enum DailyStatusEntityType {
//   LEAD
//   SUPPORT
//   TASK
//   CALL
//   PROJECT
//   OTHER
// }

// enum DailyStatusState {
//   DRAFT
//   SUBMITTED
//   REVIEWED
// }

// model DailyStatusReport {
//   id String @id @default(uuid())

//   accountId String
//   account   Account @relation(fields: [accountId], references: [id])

//   reportDate DateTime // normalized to start of day (00:00)
//   state      DailyStatusState @default(SUBMITTED)

//   summary     String? // optional overall summary
//   submittedAt DateTime?
//   reviewedAt  DateTime?
//   reviewedBy  String?
//   reviewNote  String?

//   items DailyStatusItem[]

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   @@unique([accountId, reportDate])
//   @@index([accountId])
//   @@index([reportDate])
//   @@index([state])
// }

// model DailyStatusItem {
//   id String @id @default(uuid())

//   reportId String
//   report   DailyStatusReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

//   section DailyStatusSection

//   // Optional entity linkage
//   entityType DailyStatusEntityType?
//   entityId   String? // leadId / taskId / supportId

//   title String? // fallback title (e.g., "Client follow-up")
//   note  String // actual work description / query / learning

//   // Query-specific fields
//   raisedToAccountId String?
//   resolved          Boolean @default(false)

//   // Effort tracking (optional but powerful)
//   timeSpentMinutes Int?

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   @@index([reportId])
//   @@index([section])
//   @@index([entityType, entityId])
// }

// output = "../src/generated/client"
// url      = "postgresql://postgres:raj24315@localhost:5432/shivansh-admin"
// url      = "postgresql://shivansh_app:Pinkshivansh@24315@localhost:5432/shivansh-admin"

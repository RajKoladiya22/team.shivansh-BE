// prisma/schema.prisma

datasource db {
  provider = "postgresql"
}

generator client {
  provider = "prisma-client-js"
  // output = "../src/generated/client"
}

enum AttendanceStatus {
  PRESENT
  ABSENT
  HALF_DAY
  HOLIDAY
}

enum LeaveType {
  FULL_DAY
  HALF_DAY
  MULTI_DAY
}

enum LeaveStatus {
  PENDING
  APPROVED
  REJECTED
}

enum SalaryMonthStatus {
  PENDING // not processed yet
  GENERATED // calculated
  CREDITED // salary credited
  HOLD // on hold
}

enum SalaryNoticeStatus {
  SENT
  VIEWED
  ACKNOWLEDGED
}

enum JDVisibility {
  ACTIVE
  INACTIVE
}

enum JobType {
  FULL_TIME
  REMOTE
  CONTRACT
  FREELANCE
  PART_TIME
  INTERNSHIP
  TEMPORARY
}

enum ProjectStatus {
  DRAFT
  ACTIVE
  ON_HOLD
  COMPLETED
  ARCHIVED
}

enum PipelineSource {
  TEMPLATE
  CUSTOM
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  BLOCKED
  COMPLETED
  CANCELLED
}

enum AssignmentType {
  ACCOUNT
  TEAM
}

enum ActivityEntity {
  PROJECT
  PIPELINE
  STEP
  TASK
}

enum TaskRecurrenceType {
  ONE_TIME
  DAILY
  WEEKLY
  MONTHLY
  YEARLY
  CUSTOM
}

enum TemplateAssignmentStrategy {
  SPECIFIC_USER // e.g. Always assign to the Project Manager
  PROJECT_ROLE // e.g. Assign to whoever is the "Lead Dev" on the project
  POOL // e.g. Assign to the "Design Team"
}

// ------------------------------------------------------------------
// Account Profile (Personal + Contact + Admin Approval Metadata)
// ------------------------------------------------------------------

model Account {
  id             String    @id @default(uuid())
  registerNumber String    @unique
  firstName      String
  lastName       String
  contactEmail   String    @unique
  contactPhone   String    @unique
  address        Json?
  avatar         String?
  documents      Json? // optional file metadata (Aadhar, etc.)
  bio            Json?
  isActive       Boolean   @default(false) // only true after admin approval
  jobType        JobType?
  isJdAccept     Boolean   @default(false)
  designation    String?
  joinedAt       DateTime? // set when approved
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  isBusy         Boolean   @default(false)

  activeLeadId String?
  activeLead   Lead?   @relation(fields: [activeLeadId], references: [id])

  // Relation to
  user            User?
  registration    RegistrationRequest?
  jobDescriptions JobDescription?
  teams           TeamMember[]
  taskAssignments TaskAssignment[]

  salaryStructure SalaryStructure?
  monthlySalaries MonthlySalary[]
  salaryNotices   SalaryNotice[]

  bankDetails    BankDetail?
  attendanceLogs AttendanceLog[]
  leaveRequests  LeaveRequest[]
  busyLogs       BusyActivityLog[]

  leadActivityLogs          LeadActivityLog[]
  leads                     Lead[]                     @relation("LeadCreatedBy")
  leadAssignments           LeadAssignment[]           @relation("LeadAssignedBy")
  assignedLeadAssignments   LeadAssignment[]           @relation("LeadAssignedTo")
  // linkedLeads      Lead[]            @relation("LeadAccount")
  customers                 Customer[]
  notifications             Notification[]
  notificationSubscriptions NotificationSubscription[]
  messageTemplates          MessageTemplate[]
  templatePreferences       TemplatePreference[]
  // dailyStatusReports        DailyStatusReport[]
  dsuEntries                DsuEntry[]
  leadHelpers               LeadHelper[]               @relation("HelperAccount")
  addedHelpers              LeadHelper[]               @relation("HelperAddedBy")
  // employeeLeadWorks         EmployeeLeadWork[]

  @@index([isActive])
  @@index([jobType])
  @@index([contactEmail])
}

// ------------------------------------------------------------------
// Authentication User (Login Credentials + JWT Support)
// ------------------------------------------------------------------

model User {
  id        String  @id @default(uuid())
  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique

  username           String? @unique
  passwordHash       String?
  mustChangePassword Boolean @default(true) // on first login after creation

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // RBAC
  roles UserRole[]

  // OTP for forgot password
  otps PasswordOTP[]

  @@index([username])
}

// ------------------------------------------------------------------
// Registration Approval Workflow
// ------------------------------------------------------------------

model RegistrationRequest {
  id           String   @id @default(uuid())
  firstName    String?
  lastName     String?
  contactEmail String?  @unique
  contactPhone String?  @unique
  account      Account? @relation(fields: [accountId], references: [id])
  accountId    String?  @unique

  status      String    @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedAt DateTime  @default(now())
  decidedAt   DateTime?
  decidedBy   String? // admin user id if approved/rejected
  // @@index([accountId])

  @@index([status])
  @@index([requestedAt])
}

// ------------------------------------------------------------------
// Salary & Bank
// ------------------------------------------------------------------

model SalaryStructure {
  id String @id @default(uuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  baseSalary Decimal  @db.Decimal(12, 2)
  hraPercent Decimal? @db.Decimal(5, 2) // Changed precision for percentage
  allowance  Decimal? @db.Decimal(12, 2)

  effectiveFrom DateTime

  createdBy String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  revisions SalaryRevision[]
  monthly   MonthlySalary[]

  @@index([effectiveFrom])
}

model SalaryRevision {
  id String @id @default(uuid())

  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id], onDelete: Cascade)

  previousSalary Decimal @db.Decimal(12, 2)
  revisedSalary  Decimal @db.Decimal(12, 2)

  applicableFrom DateTime
  reason         String?

  revisedBy String
  revisedAt DateTime @default(now())

  notices SalaryNotice[]

  @@index([salaryStructureId])
  @@index([applicableFrom])
}

model MonthlySalary {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  salaryStructureId String
  salaryStructure   SalaryStructure @relation(fields: [salaryStructureId], references: [id])

  month Int
  year  Int

  basic      Decimal @db.Decimal(12, 2)
  hra        Decimal @db.Decimal(12, 2)
  allowances Decimal @db.Decimal(12, 2)
  deductions Decimal @db.Decimal(12, 2)
  netPay     Decimal @db.Decimal(12, 2)

  status SalaryMonthStatus @default(PENDING)

  note String?

  generatedAt DateTime?
  creditedAt  DateTime?

  statement SalaryStatement?
  notices   SalaryNotice[]

  @@unique([accountId, month, year])
  @@index([status])
  @@index([year, month])
}

model SalaryStatement {
  id String @id @default(uuid())

  monthlySalaryId String        @unique
  monthlySalary   MonthlySalary @relation(fields: [monthlySalaryId], references: [id], onDelete: Cascade)

  generatedAt DateTime @default(now())
  pdfUrl      String?
}

model SalaryNotice {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  revisionId String?
  revision   SalaryRevision? @relation(fields: [revisionId], references: [id], onDelete: SetNull)

  monthlySalaryId String?
  monthlySalary   MonthlySalary? @relation(fields: [monthlySalaryId], references: [id], onDelete: SetNull)

  message String?
  status  SalaryNoticeStatus @default(SENT)

  sentBy         String
  sentAt         DateTime  @default(now())
  viewedAt       DateTime?
  acknowledgedAt DateTime?

  @@index([accountId])
  @@index([sentAt])
}

model BankDetail {
  id String @id @default(uuid())

  accountId String  @unique
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  bankName      String
  accountHolder String
  accountNumber String // üîê encrypt at application level
  ifscCode      String
  branch        String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ------------------------------------------------------------------
// Attendan & Leave
// ------------------------------------------------------------------

model AttendanceLog {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  date     DateTime // normalized to 00:00
  day      String // Monday, Tuesday...
  checkIn  DateTime?
  checkOut DateTime?

  status   AttendanceStatus @default(PRESENT)
  isSunday Boolean          @default(false)

  createdAt DateTime @default(now())

  @@unique([accountId, date])
  @@index([date])
}

model LeaveRequest {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  type      LeaveType
  startDate DateTime
  endDate   DateTime?

  reason String

  status LeaveStatus @default(PENDING)

  decidedBy      String? // admin accountId
  decisionReason String?
  decidedAt      DateTime?

  createdAt DateTime @default(now())

  @@index([accountId])
  @@index([status])
}

// ------------------------------------------------------------------
// Busy Activity Log
// ------------------------------------------------------------------

model BusyActivityLog {
  id String @id @default(uuid())

  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  fromBusy Boolean
  toBusy   Boolean

  reason String? // Meeting, Task, Manual, Auto

  createdAt DateTime @default(now())

  @@index([accountId])
}

// ------------------------------------------------------------------
// RBAC: Roles & Permissions
// ------------------------------------------------------------------

model Role {
  id          String  @id @default(uuid())
  name        String  @unique
  description String?

  userRoles   UserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String  @id @default(uuid())
  key         String  @unique // e.g. "USER_CREATE"
  description String?

  rolePermissions RolePermission[]
}

model UserRole {
  user   User   @relation(fields: [userId], references: [id])
  userId String
  role   Role   @relation(fields: [roleId], references: [id])
  roleId String

  @@id([userId, roleId])
}

model RolePermission {
  role         Role       @relation(fields: [roleId], references: [id])
  roleId       String
  permission   Permission @relation(fields: [permissionId], references: [id])
  permissionId String

  @@id([roleId, permissionId])
}

// ------------------------------------------------------------------
// Forgot Password OTP Store
// ------------------------------------------------------------------

model PasswordOTP {
  id        String   @id @default(uuid())
  user      User     @relation(fields: [userId], references: [id])
  userId    String
  otpCode   String // hashed or plain if ephemeral
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  @@index([userId, used])
}

// ------------------------------------------------------------------
// Job Description Store
// ------------------------------------------------------------------

model JobDescription {
  id String @id @default(uuid())

  account   Account @relation(fields: [accountId], references: [id])
  accountId String  @unique

  title       String // e.g. "Backend Developer"
  designation String? // optional mapping to Account.designation
  summary     String? // short JD intro

  responsibilitiesMust    Json // must do
  responsibilitiesMay     Json // may do
  responsibilitiesMustNot Json // not allowed / must not do

  companyRules Json // HR / company rules
  expectations Json? // KPIs / expectations
  notes        Json?

  visibility JDVisibility @default(ACTIVE)

  createdBy String? // admin user id
  updatedBy String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([designation])
  @@index([visibility])
}

// ------------------------------------------------------------------
// Team Store
// ------------------------------------------------------------------

model Team {
  id          String  @id @default(uuid())
  name        String
  description String?

  // Ownership / audit
  createdBy String? // admin/user id
  isActive  Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  members         TeamMember[]
  taskAssignments TaskAssignment[]
  leadAssignments LeadAssignment[]
  dsuTemplates    DsuTemplate[]

  @@unique([name])
  @@index([isActive])
}

model TeamMember {
  id String @id @default(uuid())

  team   Team   @relation(fields: [teamId], references: [id], onDelete: Cascade)
  teamId String

  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  accountId String

  isActive Boolean @default(true)

  // Optional team-level role (future-ready)
  role     String? // e.g. LEAD, MEMBER
  joinedAt DateTime @default(now())

  @@unique([teamId, accountId]) // prevents duplicate membership
  @@index([accountId])
  @@index([teamId])
}

// ------------------------------------------------------------------
// Project Store
// ------------------------------------------------------------------

model Project {
  id          String        @id @default(uuid())
  name        String
  description String?
  status      ProjectStatus @default(DRAFT)

  startDate DateTime?
  endDate   DateTime?

  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  createdBy String? // accountId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  pipeline ProjectPipeline?
  tasks    Task[]
  activity ActivityLog[]

  @@index([status])
}

model PipelineTemplate {
  id          String  @id @default(uuid())
  name        String
  description String?
  isActive    Boolean @default(true)

  createdBy String? // accountId
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps PipelineTemplateStep[]

  @@unique([name])
  @@index([isActive])
}

model PipelineTemplateStep {
  id String @id @default(uuid())

  templateId String
  template   PipelineTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  name        String
  order       Int
  description String?

  defaultTasks PipelineTemplateTask[] // [{ title, description, role, assignees }]

  @@index([templateId])
  @@index([order])
}

model PipelineTemplateTask {
  id     String               @id @default(uuid())
  stepId String
  step   PipelineTemplateStep @relation(fields: [stepId], references: [id], onDelete: Cascade)

  title       String
  description String?

  // Logic for due dates relative to project start
  offsetDays Int? @default(0) // e.g. Due 2 days after step starts

  // Who should this be assigned to by default?
  defaultAssignmentStrategy TemplateAssignmentStrategy?
  defaultRoleId             String? // If strategy is PROJECT_ROLE

  @@index([stepId])
}

// ------------------------------------------------------------------
// Live Project Pipeline
// ------------------------------------------------------------------

model ProjectPipeline {
  id String @id @default(uuid())

  projectId String  @unique
  project   Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  source           PipelineSource
  sourceTemplateId String?

  settings Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  steps PipelineStep[]
}

model PipelineStep {
  id String @id @default(uuid())

  pipeline   ProjectPipeline @relation(fields: [pipelineId], references: [id], onDelete: Cascade)
  pipelineId String

  name   String
  order  Int
  status TaskStatus @default(PENDING)

  templateStepId String?

  tasks Task[]

  @@index([pipelineId])
  @@index([order])
}

model Task {
  id String @id @default(uuid())

  project   Project? @relation(fields: [projectId], references: [id], onDelete: Cascade)
  projectId String?

  step   PipelineStep? @relation(fields: [stepId], references: [id])
  stepId String?

  title       String
  description String?
  status      TaskStatus @default(PENDING)
  priority    Int?       @default(1)
  isSelfTask  Boolean?

  startDate DateTime?
  dueDate   DateTime?

  startedAt   DateTime?
  completedAt DateTime?
  cancelledAt DateTime?

  // Recurrence (Unified here instead of a separate table)
  isRecurring    Boolean            @default(false)
  recurrenceType TaskRecurrenceType @default(ONE_TIME)
  recurrenceRule Json? // Cron config or custom rule

  templateTaskId String?

  createdBy String? // accountId
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  assignments TaskAssignment[]
  activity    ActivityLog[]

  // Self-referencing for Subtasks
  parentTaskId String?
  parentTask   Task?   @relation("SubTasks", fields: [parentTaskId], references: [id])
  subTasks     Task[]  @relation("SubTasks")

  @@index([projectId])
  @@index([stepId])
  @@index([status])
  @@index([deletedAt])
}

model TaskAssignment {
  id String @id @default(uuid())

  task   Task   @relation(fields: [taskId], references: [id], onDelete: Cascade)
  taskId String

  type      AssignmentType
  accountId String?
  account   Account?       @relation(fields: [accountId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  assignedAt DateTime @default(now())
  assignedBy String?

  status    TaskStatus @default(PENDING)
  note      String?
  updatedAt DateTime?

  @@index([taskId])
  @@index([accountId])
  @@index([teamId])
}

model ActivityLog {
  id String @id @default(uuid())

  entityType ActivityEntity
  entityId   String

  action String // CREATED, UPDATED, ASSIGNED, COMPLETED, MOVED
  meta   Json?

  performedBy String? // accountId
  createdAt   DateTime @default(now())

  project   Project? @relation(fields: [projectId], references: [id])
  projectId String?

  task   Task?   @relation(fields: [taskId], references: [id])
  taskId String?

  fromState Json?
  toState   Json?
  snapshot  Json?

  @@index([entityType, entityId])
  @@index([createdAt])
}

// ------------------------------------------------------------------
// Lead & Support Store
// ------------------------------------------------------------------

enum LeadSource {
  MANUAL
  WHATSAPP
  INQUIRY_FORM
  WEBSITE
  YOUTUBE
  ADVERTISEMENT
}

enum LeadType {
  LEAD
  SUPPORT
}

enum LeadStatus {
  PENDING
  IN_PROGRESS
  DEMO_DONE
  INTERESTED
  CONVERTED
  CLOSED
}

enum LeadActivityAction {
  CREATED
  ASSIGNED
  STATUS_CHANGED
  ASSIGN_CHANGED
  UPDATED
  CLOSED
  HELPER_ADDED
  HELPER_REMOVED
  WORK_STARTED
  WORK_ENDED
}

enum LeadHelperRole {
  EXPORT
  SUPPORT
  CONSULT
}

model Lead {
  id String @id @default(uuid())

  source     LeadSource
  type       LeadType
  status     LeadStatus @default(PENDING)
  statusMark Json?

  demoScheduledAt DateTime?
  demoDoneAt      DateTime?
  demoCount       Int       @default(0)
  demoMeta        Json?
  // {
  //   history: [
  //     { type: "SCHEDULED", at: DateTime, by: accountId },
  //     { type: "RESCHEDULED", at: DateTime, by: accountId },
  //     { type: "DONE", at: DateTime, by: accountId }
  //   ]
  // }

  customerName String
  mobileNumber String
  product      Json? // { id, slug, link, title }
  productTitle String? // denormalized for fast search/filter
  cost         Decimal? @db.Decimal(12, 2)
  remark       String?

  isActive  Boolean @default(true)
  isWorking Boolean @default(false)

  createdBy    String? // accountId
  createdByAcc Account?  @relation("LeadCreatedBy", fields: [createdBy], references: [id])
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  closedAt     DateTime?

  totalWorkSeconds Int @default(0)

  // account     Account?          @relation("LeadAccount", fields: [accountId], references: [id])
  // accountId   String?
  assignments LeadAssignment[]
  activity    LeadActivityLog[]
  customer    Customer?         @relation(fields: [customerId], references: [id])
  customerId  String?
  leadHelpers LeadHelper[]
  // employeeLeadWorks EmployeeLeadWork[]
  accounts    Account[]

  @@index([isWorking])
  @@index([createdAt, status])
  @@index([status, demoScheduledAt])
  @@index([status])
  @@index([mobileNumber])
  @@index([demoScheduledAt])
  @@index([demoDoneAt])
}

model LeadAssignment {
  id String @id @default(uuid())

  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)
  leadId String

  type      AssignmentType
  accountId String?
  account   Account?       @relation("LeadAssignedTo", fields: [accountId], references: [id])

  teamId String?
  team   Team?   @relation(fields: [teamId], references: [id])

  remark      Json?
  WorkSeconds Int   @default(0)

  isActive Boolean @default(true)

  assignedBy    String? // accountId (who made assignment)
  assignedByAcc Account? @relation("LeadAssignedBy", fields: [assignedBy], references: [id])

  assignedAt   DateTime  @default(now())
  unassignedAt DateTime? // null when active

  @@index([leadId])
  @@index([accountId])
  @@index([teamId])
}

model LeadHelper {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  accountId String
  account   Account @relation("HelperAccount", fields: [accountId], references: [id])

  role LeadHelperRole @default(EXPORT)

  addedBy    String? // accountId
  addedByAcc Account? @relation("HelperAddedBy", fields: [addedBy], references: [id])

  isActive Boolean @default(true)

  addedAt   DateTime  @default(now())
  removedAt DateTime?

  @@unique([leadId, accountId])
  @@index([leadId])
  @@index([accountId])
}

model LeadActivityLog {
  id String @id @default(uuid())

  leadId String
  lead   Lead   @relation(fields: [leadId], references: [id], onDelete: Cascade)

  action LeadActivityAction
  meta   Json?

  performedBy        String? // accountId
  performedByAccount Account? @relation(fields: [performedBy], references: [id])
  createdAt          DateTime @default(now())

  @@index([leadId])
  @@index([createdAt])
}

// ------------------------------------------------------------------
// Customer Store
// ------------------------------------------------------------------

model Customer {
  id               String  @id @default(uuid())
  name             String
  mobile           String // raw input or formatted
  normalizedMobile String  @unique // used for dedupe/lookups
  emails           Json? // e.g. [{ type, value }]
  phones           Json? // extra numbers
  addresses        Json? // structured addresses
  notes            String?
  isActive         Boolean @default(true)

  createdBy    String?
  createdByAcc Account? @relation(fields: [createdBy], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  leads Lead[]

  @@index([normalizedMobile])
  @@index([createdAt])
}

// ------------------------------------------------------------------
// Notification Store
// ------------------------------------------------------------------

enum NotificationCategory {
  SYSTEM
  REMINDER
  ALERT
  WARNING
  MESSAGE
  TASK
  LEAD
  CUSTOM
}

enum NotificationLevel {
  INFO
  SUCCESS
  WARNING
  ERROR
  CRITICAL
}

model Notification {
  id        String   @id @default(uuid())
  accountId String? // null = broadcast/all
  account   Account? @relation(fields: [accountId], references: [id])

  category NotificationCategory
  level    NotificationLevel    @default(INFO)

  title            String
  body             String // short body
  payload          Json? // full structured payload (for UI / actions)
  actionUrl        String? // browser action target
  dedupeKey        String? // idempotency / merge key e.g. "task:123:reminder"
  deliveryChannels Json? // ["push","socket","email"]

  // client states
  isRead      Boolean   @default(false)
  isHidden    Boolean   @default(false) // user-specific hide
  dismissedAt DateTime?
  remindAt    DateTime? // snooze/reschedule timestamp

  // audit
  createdBy String? // admin/account id who created
  createdAt DateTime  @default(now())
  sentAt    DateTime? // when delivery attempted
  expiresAt DateTime? // optional TTL

  @@index([accountId])
  @@index([category])
  @@index([createdAt])
  @@index([isRead])
  @@index([dedupeKey])
}

model NotificationSubscription {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  // WebPush fields
  endpoint String @unique
  p256dh   String
  auth     String

  // meta
  platform  String? // "web", "chrome", "android", "ios"
  userAgent String?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([accountId])
}

// ------------------------------------------------------------------
// Message Template Store (Simple & Dynamic)
// ------------------------------------------------------------------

enum MessageChannel {
  WHATSAPP
  EMAIL
  SMS
  IN_APP
  PUSH
}

enum TemplateVisibility {
  PRIVATE // account-specific
  PUBLIC // global/shared
}

model MessageTemplate {
  id String @id @default(uuid())

  // Identity
  name        String
  slug        String
  description String?

  // Ownership & visibility
  visibility TemplateVisibility @default(PRIVATE)
  accountId  String?
  account    Account?           @relation(fields: [accountId], references: [id])

  // Channel support
  channels Json
  subject  String?
  body     String

  // Placeholder metadata
  variables Json?
  meta      Json?

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Visibility
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  isDefault  Boolean   @default(false) // ‚≠ê recommended template
  lastUsedAt DateTime? // üß† for smart sorting

  // Behavior
  isActive Boolean @default(true)

  // Audit
  createdBy           String?
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  templatePreferences TemplatePreference[]

  @@unique([accountId, slug])
  @@index([visibility])
  @@index([accountId])
  @@index([isActive])
  @@index([lastUsedAt])
}

model TemplatePreference {
  id        String  @id @default(uuid())
  accountId String
  account   Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  templateId String
  template   MessageTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  // per-account overrides
  isPinned Boolean @default(false)
  priority Int     @default(0)
  isHidden Boolean @default(false) // user chose to hide this template

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([accountId, templateId])
  @@index([accountId])
  @@index([templateId])
}

// ------------------------------------------------------------------
// DSU Store (Daily Status Updates)
// ------------------------------------------------------------------

enum DsuFieldType {
  TEXT
  TEXTAREA
  NUMBER
  SELECT
  MULTISELECT
  DATE
  CHECKBOX
  RICH_TEXT
  ATTACHMENT
}

model DsuTemplate {
  id          String   @id @default(uuid())
  name        String
  description String?
  teamId      String? // optional: template scoped to a team
  createdBy   String? // accountId of creator
  isActive    Boolean  @default(true)
  config      Json // canonical JSON description of sections & fields (also denormalized below)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // relations
  team       Team?                @relation(fields: [teamId], references: [id])
  versions   DsuTemplateVersion[]
  dsuEntries DsuEntry[]

  @@index([teamId])
  @@index([isActive])
}

model DsuTemplateVersion {
  id         String      @id @default(uuid())
  templateId String
  template   DsuTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  version    Int
  config     Json // snapshot of config for this version
  createdBy  String?
  createdAt  DateTime    @default(now())

  @@unique([templateId, version])
  @@index([templateId])
}

model DsuEntry {
  id          String    @id @default(uuid())
  templateId  String? // optional ‚Äî if null, free-form
  accountId   String
  teamId      String? // convenience denormalization
  date        DateTime // normalized to midnight (the day this DSU is for)
  content     Json // the actual filled content following template structure
  summary     String? // optional short summary for display / notifications
  attachments Json? // array of { name, url, meta }
  isDraft     Boolean   @default(false)
  submittedAt DateTime?
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  createdBy   String // accountId who submitted (usually same as accountId)
  meta        Json? // free metadata (ip, device, client-version, etc)
  textSearch  String? // denormalized searchable text (updated by app)

  // relations
  template DsuTemplate? @relation(fields: [templateId], references: [id])
  account  Account      @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@unique([accountId, date, templateId])
  @@index([accountId])
  @@index([teamId])
  @@index([date])
  @@index([submittedAt])
}

// enum DailyStatusSection {
//   WORKED_ON // Completed work
//   IN_PROGRESS // Started but not completed
//   QUERY // Blocker / question
//   LEARNING // Today's learning
// }

// enum DailyStatusEntityType {
//   LEAD
//   SUPPORT
//   TASK
//   CALL
//   PROJECT
//   OTHER
// }

// enum DailyStatusState {
//   DRAFT
//   SUBMITTED
//   REVIEWED
// }

// model DailyStatusReport {
//   id String @id @default(uuid())

//   accountId String
//   account   Account @relation(fields: [accountId], references: [id])

//   reportDate DateTime // normalized to start of day (00:00)
//   state      DailyStatusState @default(SUBMITTED)

//   summary     String? // optional overall summary
//   submittedAt DateTime?
//   reviewedAt  DateTime?
//   reviewedBy  String?
//   reviewNote  String?

//   items DailyStatusItem[]

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   @@unique([accountId, reportDate])
//   @@index([accountId])
//   @@index([reportDate])
//   @@index([state])
// }

// model DailyStatusItem {
//   id String @id @default(uuid())

//   reportId String
//   report   DailyStatusReport @relation(fields: [reportId], references: [id], onDelete: Cascade)

//   section DailyStatusSection

//   // Optional entity linkage
//   entityType DailyStatusEntityType?
//   entityId   String? // leadId / taskId / supportId

//   title String? // fallback title (e.g., "Client follow-up")
//   note  String // actual work description / query / learning

//   // Query-specific fields
//   raisedToAccountId String?
//   resolved          Boolean @default(false)

//   // Effort tracking (optional but powerful)
//   timeSpentMinutes Int?

//   createdAt DateTime @default(now())
//   updatedAt DateTime @updatedAt

//   @@index([reportId])
//   @@index([section])
//   @@index([entityType, entityId])
// }

// output = "../src/generated/client"
// url      = "postgresql://postgres:raj24315@localhost:5432/shivansh-admin"
// url      = "postgresql://shivansh_app:Pinkshivansh@24315@localhost:5432/shivansh-admin"
